apiVersion: v1
kind: Pod
metadata:
  name: llama-stack-service
  namespace: e2e-rhoai-dsc
spec:
  imagePullSecrets:
    - name: quay-lightspeed-pull-secret
  initContainers:
    - name: setup-rag-data
      image: busybox:latest
      command:
        - /bin/sh
        - -c
        - |
          mkdir -p /data/storage/rag
          gunzip -c /rag-data/kv_store.db.gz > /data/storage/rag/kv_store.db
          echo "RAG data extracted successfully"
          ls -la /data/storage/rag/
      volumeMounts:
        - name: app-root
          mountPath: /data
        - name: rag-data
          mountPath: /rag-data
  containers:
    - name: llama-stack-container
      command: ["llama", "stack", "run", "/opt/app-root/run.yaml"]
      env:
        - name: KSVC_URL
          valueFrom:
            secretKeyRef:
              name: api-url-secret
              key: key
        - name: VLLM_API_KEY
          valueFrom:
            secretKeyRef:
              name: vllm-api-key-secret
              key: key
        - name: INFERENCE_MODEL
          value: "meta-llama/Llama-3.1-8B-Instruct"
        - name: FAISS_VECTOR_STORE_ID
          valueFrom:
            secretKeyRef:
              name: faiss-vector-store-secret
              key: id
      image: ${LLAMA_STACK_IMAGE}
      ports:
        - containerPort: 8321
      volumeMounts:
        - name: app-root
          mountPath: /opt/app-root/src/.llama
        - name: config
          mountPath: /opt/app-root/run.yaml
          subPath: run.yaml
  volumes:
    - name: app-root
      emptyDir: {}
    - name: config
      configMap:
        name: llama-stack-config
    - name: rag-data
      configMap:
        name: rag-data
